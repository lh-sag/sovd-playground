# osovd-gateway Test Framework

This directory contains integration tests for the osovd-gateway server using pytest with the `sh` module for
asynchronous process management.

## Setup

### Prerequisites

- Python 3.12+
- Rust toolchain (for building osovd-gateway)
- uv package manager (recommended) or pip

### Installation

```bash
# Install dependencies with uv (recommended)
uv sync
```

## Running Tests

### Basic test execution

```bash
# Run tests with verbose output and show prints
uv run pytest -v -s
```

### Custom Gateway binary and arguments

By default, tests use `cargo run --bin osovd-gateway`. You can override this:

```bash
# Use a pre-built binary
uv run pytest --osovd-gateway-bin=./target/release/osovd-gateway

# Use a custom binary path
uv run pytest --osovd-gateway-bin=/path/to/your/osovd-gateway
```

Pass additional arguments to the gateway process:

```bash
# Add custom arguments
uv run pytest --osovd-gateway-args="--url http://127.0.0.1:8080/opensovd"

# Use a specific cargo profile for building (default: dev)
uv run pytest --osovd-gateway-profile=release

# Combine options
uv run pytest --osovd-gateway-profile=release --osovd-gateway-args="--url http://127.0.0.1:0/my-api"
```

### Certificate Tests

The test suite includes HTTPS tests using certificates generated by the `mkcerts.sh` script:

```bash
# Run certificate tests specifically
uv run pytest -v -s -k "cert"

# Run certificate tests with release profile for better performance
uv run pytest -v -s -k "cert" --osovd-gateway-profile=release

# Skip certificate tests (useful if openssl feature is not available)
uv run pytest -v -s -k "not cert"
```

**Note**: Certificate tests require the `openssl` feature to be enabled when building the gateway. The tests
automatically generate temporary certificates with 30-day validity using the `scripts/mkcerts.sh` script.

## Test Structure

### Fixtures

- **`gateway_manager`**: Provides a `GatewayManager` instance for manual server control
- **`gateway_args`**: Default arguments for osovd-gateway (can be overridden)
- **`gateway_env`**: Default environment variables for osovd-gateway (can be overridden)
- **`project_root`**: Path to the project root directory
- **`cert_dir`**: Path to generated certificates (certificate tests only)

### GatewayManager

The `GatewayManager` class provides lifecycle management for the gateway process using the `sh` module with
`_iter=True` for simple async output handling:

```python
def test_example(gateway_manager):
    # Start the gateway
    base_url = gateway_manager.start()

    # Make requests to the gateway
    response = requests.get(base_url)

    # Access process information
    pid = gateway_manager.get_pid()

    # Iterate over log lines (new Pythonic way)
    for log_line in gateway_manager:
        if "listening on:" in log_line:
            print(f"Found server: {log_line}")

    # Stop the gateway
    gateway_manager.stop()
```

### URL and Port Extraction

The framework automatically extracts the server URL from the gateway's log output by:

1. Starting the gateway with port 0 (auto-allocation): `--url http://127.0.0.1:0/opensovd`
2. Using `sh` module's `_iter=True` to iterate over stdout lines without blocking
3. Parsing the actix server log to find the actual allocated port:

   ```text
   listening on: 127.0.0.1:PORT
   ```

4. Constructing the full URL: `http://127.0.0.1:PORT/opensovd`

This approach uses `sh`'s simple iterator interface, avoiding threads and callbacks while ensuring no port conflicts.

### Log Access

The `GatewayManager` is iterable, allowing Pythonic access to log lines:

```python
# Iterate over logs directly
for log_line in gateway_manager:
    if "error" in log_line.lower():
        print(f"Found error: {log_line}")

# Use with any iterable operation
startup_logs = [line for line in gateway_manager if "starting" in line.lower()]
log_text = " ".join(gateway_manager)  # Join all logs
log_count = len(list(gateway_manager))  # Count log lines
```

## Writing Custom Tests

### Using fixture override with gateway

```python
# Override the args and env fixtures
@pytest.fixture
def gateway_args():
    """Custom args for this test."""
    return ["--url", "http://127.0.0.1:0/my-api"]

@pytest.fixture
def gateway_env():
    """Custom environment for this test."""
    return {"RUST_LOG": "debug", "MY_VAR": "test"}

def test_with_fixture_override(gateway):
    """Test using fixture override - automatic handling."""
    # Gateway is already started with custom args and env
    response = requests.get(gateway.base_url, timeout=5)
    assert response.status_code in [200, 404, 405]

    # Iterate over logs to check for expected messages
    for log_line in gateway:
        if "listening on:" in log_line:
            print(f"Server is listening: {log_line}")
    # Automatic cleanup
```

### Log Analysis

```python
def test_log_analysis(gateway_manager):
    """Test using log iteration for analysis."""
    base_url = gateway_manager.start()

    # Find specific log messages
    error_logs = [line for line in gateway_manager if "error" in line.lower()]
    startup_logs = [line for line in gateway_manager if "starting" in line.lower()]

    assert len(startup_logs) > 0, "Should have startup messages"
    assert len(error_logs) == 0, "Should have no error messages"

    gateway_manager.stop()

## Troubleshooting

### Gateway fails to start

1. Ensure osovd-gateway can be built: `cargo build --bin osovd-gateway`
2. Port conflicts are avoided by using port 0 (automatic allocation)

### Process cleanup issues

If tests leave gateway processes running:

```bash
pkill -f osovd-gateway
```

## Configuration

Test configuration is in `pyproject.toml`:

- pytest options under `[tool.pytest.ini_options]`
- Dependencies under `[project.dependencies]`
- Code formatting and linting with ruff under `[tool.ruff]`

## CI Integration

For continuous integration:

```bash
# Install dependencies with uv
uv sync

# Build the binary
cargo build --bin osovd-gateway --profile=release

# Run tests with pre-built binary
uv run pytest tests/ -v --osovd-gateway-bin=./target/release/osovd-gateway

# Or run tests with cargo build (using release profile)
uv run pytest tests/ -v --osovd-gateway-profile=release

# Run linting and formatting
uv run ruff check tests/
uv run ruff format tests/

# Run only basic tests (skip certificate tests if openssl feature not available)
uv run pytest tests/ -v -k "not cert"
```

## UI Tests with Playwright

The test suite includes UI tests using Playwright for browser automation.

### Setup UI Tests

UI tests require Playwright browsers to be installed:

```bash
# Install Playwright browsers
uv run playwright install

# Or use the provided script with retry logic
./scripts/install-playwright.sh
```

### Running UI Tests

```bash
# Run all tests including UI tests
uv run pytest -v

# Run only UI tests
uv run pytest tests/ui/ -v

# Skip UI tests if browsers are not available
uv run pytest -v -k "not ui"
```

### UI Test Troubleshooting

**Problem**: `BrowserType.launch: Executable doesn't exist`
**Solution**: Install Playwright browsers:

```bash
uv run playwright install
```

**Problem**: Network issues during browser installation
**Solution**: Use the retry script:

```bash
./scripts/install-playwright.sh
```

**Problem**: UI tests are automatically skipped
**Cause**: Playwright browsers are not installed or detection failed
**Solution**:

1. Install browsers: `uv run playwright install`
2. Check installation: `ls ~/.cache/ms-playwright/`
3. UI tests will automatically skip if browsers are unavailable

**Problem**: Scope mismatch errors in fixtures
**Cause**: Session-scoped fixtures trying to access function-scoped fixtures
**Solution**: This has been fixed - `gateway_url` fixture is now function-scoped

### UI Test Configuration

- Browser: Chromium (headless)
- Viewport: 1280x720
- Security: Ignores HTTPS errors for self-signed certificates
- Screenshots: Only on failure
- Videos: Retained on failure
